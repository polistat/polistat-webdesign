<div id="chart">
	<div id="yAxis">
		<p>0</p>
		<p>10</p>
		<p>20</p>
		<p>30</p>
		<p>40</p>
		<p>50</p>
		<p>60</p>
		<p>70</p>
		<p>80</p>
		<p>90</p>
		<p>100</p>
	</div>
	<svg id="timeseries">
		<defs>
			<linearGradient id="oracle_gradient" x1="-0.497355" y1="2.17398e-08" x2="-0.497573" y2="378" gradientUnits="userSpaceOnUse">
				<stop stop-color="#1B6CE5"/>
				<stop offset="1" stop-color="#FF2E2E"/>
			</linearGradient>
		</defs>
	</svg>
	<div id="xAxis"></div>
</div>
<p id="endlabel">Nov 3</p>
<p id="datelabel">Oct 12</p>
<script>
function datestring(date) {
	date = date.toLocaleDateString("en-US").split('/')
	return (date[0] === '9' ? 'Sep' : date[0] === '10' ? 'Oct' : date[0] === '11' ? 'Nov' : 'Err') + ' ' + date[1]
}

function draw() {
	let height = timeseries.getBoundingClientRect().height - 20
	let width = timeseries.getBoundingClientRect().width
	bidenline.setAttributeNS(null, 'points', biden.slice(0, day+1).map((p, i) => i*(width / days)+','+((1-p/100) * height + 10)))
	trumpline.setAttributeNS(null, 'points', trump.slice(0, day+1).map((p, i) => i*(width / days)+','+((1-p/100) * height + 10)))
	lightbidenline.setAttributeNS(null, 'points', biden.map((p, i) => i*(width / days)+','+((1-p/100) * height + 10)))
	lighttrumpline.setAttributeNS(null, 'points', trump.map((p, i) => i*(width / days)+','+((1-p/100) * height + 10)))	
	for (let i = 0; i < bars.length; i++) {
		bars[i].setAttributeNS(null, 'points', `0,${height*(i/(bars.length-1)) + 10} ${width - 10},${height*(i/(bars.length-1)) + 10}`)
	}

	let start = new Date('9/1/2020')
	let stop = new Date('11/3/2020')
	xAxis.innerHTML = '<p class="xlabel" id="firstDate">Sep 1</p>'
	let dateOptions = [64, 32, 16, 8, 4, 2, 1, 0]
	let dates = dateOptions.filter(a => width/(firstDate.offsetWidth*2) > a)[0]
	let labelDates = [0]
	for (let i = 1; i < dates; i++) {
		date = datestring(new Date(+start + (stop-start)*i/dates))
		labelDates.push((+new Date(date+', 2020') - +start)/(1000*60*60*24))
		xAxis.innerHTML += `<p class="xlabel">${date}</p>`
	}
	xAxis.innerHTML += '<p class="xlabel">Nov 3</p>'
	labelDates.push(63)

	let labels = document.getElementsByClassName("xlabel")
	for (let i = 0; i < labelDates.length; i++) {
		labels[i].style.left = labelDates[i]*(width / days) - labels[i].offsetWidth/2
	}

	endline.setAttributeNS(null, 'x1', width-3)
	endline.setAttributeNS(null, 'x2', width-3)
	endline.setAttributeNS(null, 'y1', 3)
	endline.setAttributeNS(null, 'y2', height+10)

	dateline.setAttributeNS(null, 'x1', Math.max(3, day*(width / days)))
	dateline.setAttributeNS(null, 'x2', Math.max(3, day*(width / days)))
	dateline.setAttributeNS(null, 'y1', 3)
	dateline.setAttributeNS(null, 'y2', height+10)

	endlabel.style.left = Math.round(endline.getBoundingClientRect().x + window.scrollX - endlabel.offsetWidth/2, 3)
	endlabel.style.top = Math.round(endline.getBoundingClientRect().y + window.scrollY - endlabel.offsetHeight, 3)

	datelabel.innerText = datestring(new Date((+new Date(start)) + day*24*60*60*1000))
	datelabel.style.left = Math.max(timeseries.getBoundingClientRect().x + window.scrollX, Math.round(dateline.getBoundingClientRect().x + window.scrollX - datelabel.offsetWidth/2, 3))
	datelabel.style.top = Math.round(dateline.getBoundingClientRect().y + window.scrollY - datelabel.offsetHeight, 3)

	bidencircle.setAttributeNS(null, 'r', 6.5)
	trumpcircle.setAttributeNS(null, 'r', 6.5)
	bidencircle.setAttributeNS(null, 'cx', Math.max(3, day*(width / days)))
	bidencircle.setAttributeNS(null, 'cy', ((1-biden[day]/100) * height + 10))
	trumpcircle.setAttributeNS(null, 'cx', Math.max(3, day*(width / days)))
	trumpcircle.setAttributeNS(null, 'cy', ((1-trump[day]/100) * height + 10))

	bidenlabel.textContent = 'Biden ' + Math.round(biden[day]) + '%'
	bidenlabel.setAttributeNS(null, 'x', Math.max(3, day*(width / days) - bidenlabel.getBoundingClientRect().width - 10))
	bidenlabel.setAttributeNS(null, 'y', ((1-biden[day]/100) * height + 10) - 15)
	trumplabel.textContent = 'Trump ' + Math.round(trump[day]) + '%'
	trumplabel.setAttributeNS(null, 'x', Math.max(3, day*(width / days) - trumplabel.getBoundingClientRect().width - 10))
	trumplabel.setAttributeNS(null, 'y', ((1-trump[day]/100) * height + 10) + trumplabel.getBoundingClientRect().height + 10)
}

let biden = [76.05310421458543, 76.60467630606612, 79.67487219984136, 83.36821477923039, 77.50241985924943, 81.58550378453285, 75.15149693637984, 83.98695173344045, 81.08077268316298, 76.68317412627611, 80.35303294925244, 80.99523272494933, 77.05017370912206, 78.45920916704769, 82.58132801818645, 78.58529270721522, 76.41039694699691, 77.83779980690029, 76.05869232778856, 78.03811026069859, 75.47403948775823, 76.07894264544686, 83.85243705477194, 82.39339638673522, 84.28266486512707, 82.34826969058858, 75.43607254901652, 79.04067842175193, 77.383986527891, 84.50538882546932, 81.48308489407607, 75.76981919166384, 79.55428605654171, 79.07100777111542, 77.63981598505505, 83.43874812055748, 76.52356062835655, 80.60936762234482, 76.51629136228955, 75.27457924060117, 78.80613802596952, 77.62200120853389, 83.33053374333039, 83.55329004810307, 82.85080782521472, 75.95408728489419, 80.98906650922295, 83.54376212197667, 75.95227998949025, 79.96962338547053, 80.89714940625632, 84.45478508725209, 81.2285287655728, 80.19019827650378, 78.37450847336747, 77.41449612440427, 81.61088426424699, 76.95191140512432, 80.47055604168483, 77.05482443935374, 81.30672931871308, 80.94465143486347, 82.99385249537727, 84.50595974934419].slice(0, 42)
let trump = [19.06675496370447, 21.32416475397777, 19.19024120424965, 18.524629190725232, 16.146492709280697, 19.70426682727899, 22.63713462276991, 16.988623616609612, 15.250791979981262, 16.691219012335473, 17.92537731521334, 17.213071956526242, 23.99729788153121, 24.970513339698243, 15.647746747577472, 20.831224257961573, 18.236569752282485, 18.77180181899994, 21.63631320604348, 18.706677952344986, 17.66249563530816, 15.650570988942807, 17.119706205269125, 20.43954789465774, 20.83152182989071, 18.80930753371559, 23.280990288447107, 18.157185679156473, 16.51236141385929, 17.195362260832862, 17.717620916887338, 18.035930076225554, 16.108198325707818, 15.173105023092393, 20.603577748720173, 15.731281397281903, 24.9038322378465, 22.977247325169863, 17.534008669341098, 17.198329906374024, 22.528535239219824, 18.601059673479263, 21.033869458546985, 16.933382127150615, 17.03134906569685, 17.988111889849506, 21.765745753095313, 17.685280893373143, 21.661007403141173, 19.62423150583295, 22.101141846493498, 18.31390408466566, 19.976803734066152, 17.051853867006784, 17.199554749905303, 17.166099088841587, 24.80095862331031, 19.40757255397651, 18.157649583074743, 16.639528624605735, 22.64003459951752, 23.978586273864153, 22.097637581614073, 16.32179421588434].slice(0, 42)
let days = 64;
let day = biden.length - 1;

let bars = []
for (let i = 0; i < 11; i++) {
	bars.push(document.createElementNS("http://www.w3.org/2000/svg", "polyline"))
	bars[i].classList.add("dashed")
	timeseries.appendChild(bars[i])
}

let endline = document.createElementNS("http://www.w3.org/2000/svg", "line")
let dateline = document.createElementNS("http://www.w3.org/2000/svg", "line")
endline.classList.add("endline")
dateline.classList.add("dateline")
timeseries.appendChild(endline)
timeseries.appendChild(dateline)


let lightbidenline = document.createElementNS("http://www.w3.org/2000/svg", "polyline")
let lighttrumpline = document.createElementNS("http://www.w3.org/2000/svg", "polyline")
lightbidenline.classList.add('lightbidenline')
lighttrumpline.classList.add('lighttrumpline')
timeseries.appendChild(lightbidenline)
timeseries.appendChild(lighttrumpline)

let bidenline = document.createElementNS("http://www.w3.org/2000/svg", "polyline")
let trumpline = document.createElementNS("http://www.w3.org/2000/svg", "polyline")
bidenline.classList.add('bidenline')
trumpline.classList.add('trumpline')
timeseries.appendChild(bidenline)
timeseries.appendChild(trumpline)

let bidencircle = document.createElementNS("http://www.w3.org/2000/svg", "circle")
let trumpcircle = document.createElementNS("http://www.w3.org/2000/svg", "circle")
bidencircle.classList.add('bidencircle')
trumpcircle.classList.add('trumpcircle')
timeseries.appendChild(bidencircle)
timeseries.appendChild(trumpcircle)

let bidenlabel = document.createElementNS("http://www.w3.org/2000/svg", "text")
let trumplabel = document.createElementNS("http://www.w3.org/2000/svg", "text")
bidenlabel.classList.add('bidenlabel')
trumplabel.classList.add('trumplabel')
timeseries.appendChild(bidenlabel)
timeseries.appendChild(trumplabel)

timeseries.addEventListener('mousemove', function (e) {
	day = Math.min(biden.length-1, Math.round(e.offsetX*days/timeseries.getBoundingClientRect().width))
	draw()
})

timeseries.addEventListener('load', draw)
window.addEventListener('resize', draw);
</script>
